let shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),sharedMomentsArea=document.querySelector("#shared-moments"),snackBarContainer=document.querySelector("#confirmation-toast"),form=document.querySelector("form"),titleInput=document.querySelector("#title"),locationInput=document.querySelector("#location"),videoPlayer=document.querySelector("#player"),canvasEl=document.querySelector("#canvas"),captureBtn=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image"),locationBtn=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),manualLocation=document.querySelector("#manual-location"),picture=null,fetchLocation=null;function closeCreatePostModal(){createPostArea.style.transform="translateY(100vh)",videoPlayer.style.display="none",imagePickerArea.style.display="none",canvasEl.style.display="none",locationBtn.style.display="inline",locationLoader.style.display="none",videoPlayer?.srcObject?.getVideoTracks()?.forEach(e=>e.stop())}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){var t=document.createElement("div"),a=(t.className="shared-moment-card mdl-card mdl-shadow--2dp",document.createElement("div")),o=(a.className="mdl-card__title",a.style.backgroundImage="url("+e.image+")",a.style.backgroundSize="cover",t.appendChild(a),document.createElement("h2")),a=(o.style.color="white",o.className="mdl-card__title-text",o.textContent=e.title,a.appendChild(o),document.createElement("div"));a.className="mdl-card__supporting-text",a.textContent=e.location,a.style.textAlign="center",t.appendChild(a),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){clearCards(),e.forEach(e=>createCard(e))}function handleGetLocation(){locationBtn.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(function(e){locationBtn.style.display="inline",locationLoader.style.display="none";var{latitude:e,longitude:t}=e.coords;fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=`+t).then(e=>e.json()).then(e=>{e=e.display_name;fetchLocation=e,locationInput.value=e,locationInput.classList.add("is-focused"),manualLocation.classList.add("is-focused")}).catch(e=>console.error(e))},function(e){console.log(e),locationBtn.style.display="inline",locationLoader.style.display="none",fetchLocation=null,locationInput.value="",locationInput.classList.remove("is-focused"),manualLocation.classList.remove("is-focused"),alert("Couldn't get your location")},{timeout:7e3})}function initializeLocation(){"geolocation"in navigator||(locationBtn.style.display="none")}function handleCaptureImage(e){e.preventDefault(),canvasEl.style.display="block",videoPlayer.style.display="none",captureBtn.style.display="none",canvasEl.getContext("2d").drawImage(videoPlayer,0,0,canvasEl.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasEl.width)),videoPlayer.srcObject.getVideoTracks().forEach(e=>e.stop()),canvasEl.toBlob(e=>{var t=crypto.randomUUID();picture=new File([e],t+"-picture",{type:"image/jpg"})})}function handlePickImage(e){picture=e.target.files[0]}async function initializeMedia(){"mediaDevices"in navigator||(navigator.mediaDevices={}),"getUserMedia"in navigator.mediaDevices||(navigator.mediaDevices.getUserMedia=function(a){let o=navigator.webKitGetUserMedia||navigator.mozGetUserMedia;return o?new Promise(function(e,t){o.call(navigator,a,e,t)}):Promise.reject(new Error("can not access to media"))});try{var e=await navigator.mediaDevices.getUserMedia({video:!0});videoPlayer.srcObject=e,videoPlayer.style.display="block"}catch(e){console.log(e),imagePickerArea.style.display="block"}}async function onSaveButtonClicked(e){var t;console.log("clicked"),"caches"in window&&((t=await caches.open("user-requested")).add("https://httpbin.org/get"),t.add("/src/images/sf-boat.jpg"))}async function openCreatePostModal(){createPostArea.style.transform="translateY(0)",await initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),"dismissed"===(await deferredPrompt.userChoice).outcome?console.log("User cancelled installation"):console.log("User added to home screen"),deferredPrompt=null)}async function handleSubmit(e){e.preventDefault();var e=new FormData(e.currentTarget),{title:e,location:t}=Object.fromEntries(e.entries());if(""===e.trim()||""===t.trim())return alert("Please enter valid data");closeCreatePostModal();var a={message:"Your Post saved for syncing!"},o={message:"Oops, something wen't wrong"};if("serviceWorker"in navigator&&"indexedDB"in window)try{var n=await navigator.serviceWorker.ready,r={id:crypto.randomUUID(),title:e,location:t,image:picture};await writeData("sync-posts",r),await n.sync.register("sync-new-post"),captureBtn.style.display="block",snackBarContainer.MaterialSnackbar.showSnackbar(a)}catch{snackBarContainer.MaterialSnackbar.showSnackbar(o)}else{console.log("DO NOT HAVE SW Enabled!!!");r={title:e,location:t,image:picture};try{await createNewPost(r);var i=await getAllPosts();snackBarContainer.MaterialSnackbar.showSnackbar(a),updateUI(i)}catch(e){console.log(e),snackBarContainer.MaterialSnackbar.showSnackbar(o)}}}(async()=>{let e=!1;try{var t=await getAllPosts();t&&(e=!0,updateUI(t))}catch(e){console.log("ERROR â›”",e)}"indexedDB"in window&&(t=await readAllData("posts"),e||updateUI(t))})(),form.addEventListener("submit",handleSubmit),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal),captureBtn.addEventListener("click",handleCaptureImage),imagePicker.addEventListener("change",handlePickImage),locationBtn.addEventListener("click",handleGetLocation);